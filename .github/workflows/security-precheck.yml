name: Security Pre-flight Check

# Prevent committing secrets to repository
on:
  pull_request:
    paths-ignore:
      - '**.md'
      - '.agent/**'
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'

jobs:
  secrets-scan:
    name: Scan for exposed secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Detect .env files
        run: |
          if git ls-files --cached | grep -E '\.env(\..*)?$'; then
            echo "❌ ERROR: .env file found in git index!"
            exit 1
          else
            echo "✅ No .env files in git index"
          fi

      - name: Check for hardcoded tokens (simple pattern)
        run: |
          if grep -r "shpss_" . --include="*.ts" --include="*.tsx" --include="*.js" \
             --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist; then
            echo "❌ ERROR: Shopify token pattern found in source code!"
            exit 1
          else
            echo "✅ No hardcoded Shopify tokens detected"
          fi

  env-config-validation:
    name: Validate environment config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "❌ ERROR: .env.example not found"
            exit 1
          fi
          echo "✅ .env.example found"

      - name: Check .gitignore includes .env
        run: |
          if grep -q "^\.env" .gitignore; then
            echo "✅ .env properly listed in .gitignore"
          else
            echo "⚠️  WARNING: .env not in .gitignore"
            exit 1
          fi

      - name: Validate required env vars documented
        run: |
          required_vars=("PUBLIC_STOREFRONT_API_TOKEN" "PUBLIC_STORE_DOMAIN" "SESSION_SECRET")
          for var in "${required_vars[@]}"; do
            if grep -q "$var" .env.example; then
              echo "✅ $var documented in .env.example"
            else
              echo "❌ ERROR: $var missing from .env.example"
              exit 1
            fi
          done

  deployment-readiness:
    name: Verify Oxygen deployment config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Oxygen secret references
        run: |
          echo "✅ Deployment checks:"
          echo "   - Use GitHub repository secrets for prod tokens"
          echo "   - Never commit .env to version control"
          echo "   - Rotate tokens quarterly"
          echo "   - Reference: https://shopify.dev/docs/oxygen/configuration"

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      - secrets-scan
      - env-config-validation
      - deployment-readiness
    if: always()
    steps:
      - name: Report status
        run: |
          if [ "${{ needs.secrets-scan.result }}" != "success" ] || \
             [ "${{ needs.env-config-validation.result }}" != "success" ]; then
            echo "❌ Security checks FAILED"
            exit 1
          else
            echo "✅ All security checks PASSED"
          fi
